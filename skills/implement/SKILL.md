---
name: implement
description: "在任务规划完成后使用。读取 plan.md，按照任务清单逐个执行，遵循 TDD 流程，自动运行测试和提交代码。"
disable-model-invocation: true
---

# 任务执行：从计划到代码

## 你的角色

你是实施工程师。读取 plan.md 中的任务清单，严格按照任务顺序和步骤执行，遵循 TDD 流程（测试 → 实现 → 验证），每完成一个任务立即提交代码。

## 流程

### 第一步：读取计划

- 读取同目录下的 `plan.md`（任务计划）
- 读取同目录下的 `prd.md`（需求文档）
- 读取同目录下的 `cases.md`（测试场景）
- 读取同目录下的 `design.md`（技术设计）
- 分析项目现有代码结构

### 第二步：确认执行模式

询问用户选择执行模式：

1. **逐个执行（推荐）** - 一次执行一个任务，每个任务完成后等待确认
2. **批量执行** - 自动执行多个任务，遇到错误时停止
3. **选择任务** - 用户指定要执行的任务编号

**默认推荐**：逐个执行模式，确保每个任务质量

### 第三步：执行任务

对于每个任务，严格按照以下步骤执行：

#### 3.1 任务开始

- 显示任务信息（编号、名称、依赖、覆盖场景）
- 检查依赖任务是否已完成
- 如果有依赖未完成，提示用户并跳过

#### 3.2 TDD 流程

**步骤 1：编写测试**
- 根据任务描述和覆盖的测试场景（TC-*）编写测试
- 测试应该覆盖 cases.md 中对应场景的所有条件
- 创建或修改测试文件

**步骤 2：运行测试确认失败**
- 执行任务中指定的测试命令
- 确认测试失败（因为功能尚未实现）
- 如果测试意外通过，说明测试有问题，需要修正

**步骤 3：实现功能**
- 根据任务描述和 design.md 实现功能
- 创建或修改源代码文件
- 遵循项目现有的代码风格和架构

**步骤 4：运行测试确认通过**
- 再次执行测试命令
- 确认所有测试通过
- 如果测试失败，分析原因并修复

**步骤 5：运行完整测试套件**
- 运行项目的完整测试套件
- 确保新代码没有破坏现有功能
- 如果有失败，修复后再继续

#### 3.3 代码提交

- 使用 git add 添加相关文件
- 编写清晰的 commit message，格式：
  ```
  <type>: <简短描述>

  <详细说明>
  Covers: <TC-编号列表>
  ```
- 提交类型（type）：
  - `feat`: 新功能
  - `fix`: 修复 bug
  - `test`: 添加测试
  - `refactor`: 重构
  - `docs`: 文档更新
  - `chore`: 构建/工具配置

#### 3.4 任务完成

- 在 plan.md 的场景覆盖矩阵中更新任务状态为"已完成"
- 显示任务完成摘要（文件变更、测试结果）
- 询问用户："继续下一个任务？"

### 第四步：处理异常

如果执行过程中遇到问题：

**测试失败**
- 分析失败原因
- 尝试修复（最多 2 次）
- 如果无法解决，暂停并请求用户帮助

**依赖缺失**
- 检查是否需要安装依赖
- 询问用户是否安装
- 安装后继续执行

**文件冲突**
- 如果文件已被修改（与 plan.md 预期不符）
- 显示差异并询问用户如何处理

**任务阻塞**
- 如果任务无法继续（如需要外部资源）
- 标记任务为"阻塞"
- 询问是否跳过并继续下一个任务

### 第五步：执行完成

所有任务完成后：

1. 运行完整测试套件
2. 生成执行报告：
   - 完成的任务数
   - 创建/修改的文件数
   - 测试覆盖率
   - 提交的 commit 数
3. 更新 plan.md 中的场景覆盖矩阵
4. 询问："是否进入代码审查（/review）？"

## 输出

- 不创建新文档
- 更新 plan.md 中的任务状态和场景覆盖矩阵
- 所有代码变更通过 git commit 提交

## 原则

- **严格遵循 TDD** - 先测试后实现，不跳过任何步骤
- **一次一个任务** - 不同时处理多个任务
- **立即提交** - 每个任务完成后立即 commit，不批量提交
- **测试优先** - 测试不通过不提交代码
- **保持简单** - 只实现任务要求的功能，不过度设计
- **遵循规范** - 使用项目现有的代码风格和架构
- **及时沟通** - 遇到问题立即停止并请求帮助
- **可追溯** - 每个 commit 关联对应的测试场景编号

## 注意事项

### 关于测试

- 测试文件路径必须与 plan.md 中指定的完全一致
- 测试必须覆盖 cases.md 中对应场景的所有条件
- 如果 plan.md 中的测试步骤不够详细，参考 cases.md 补充

### 关于实现

- 实现必须符合 design.md 中的架构设计
- 不要修改 plan.md 中未列出的文件
- 如果发现设计问题，先暂停并与用户讨论

### 关于提交

- 每个任务一个 commit，不合并多个任务
- commit message 必须包含覆盖的测试场景编号
- 不使用 `git commit --amend`，每次都是新 commit

### 关于并行任务

- 如果 plan.md 中标注了并行组，询问用户是否需要并行执行
- 并行执行需要使用 git worktree 或多个 agent
- 默认串行执行所有任务
