# [Issue ID] - 调试报告

> 本文档记录 bug 调试的完整过程，包括根因调查、模式分析、假设验证和修复实施。

## 基本信息

- **问题 ID**：[如 BUG-001 或 GitHub Issue #123]
- **调试日期**：YYYY-MM-DD
- **问题类型**：测试失败 / 生产 bug / 意外行为 / 性能问题 / 构建失败 / 集成问题
- **严重程度**：P0 (阻塞) / P1 (紧急) / P2 (正常) / P3 (低)
- **相关文档**：
  - PRD：[如 docs/plans/YYYY-MM-DD/feature-name/prd.md]
  - 测试场景：[如 docs/plans/YYYY-MM-DD/feature-name/cases.md]
  - 技术设计：[如 docs/plans/YYYY-MM-DD/feature-name/design.md]

---

## 问题描述

### 症状

**表现**：
- [问题的外在表现，如错误信息、异常行为、性能下降等]

**触发条件**：
- [如何触发此问题的详细步骤]

**影响范围**：
- 受影响的功能：[列出受影响的功能模块]
- 受影响的场景：[如 TC-FAULT-001, TC-BOUND-002]
- 受影响的用户：[如所有用户 / 特定条件的用户]

### 错误信息

```
[完整的错误堆栈或日志输出]
```

**关键信息**：
- 文件：[文件路径]
- 行号：[错误发生的行号]
- 错误类型：[如 TypeError, AssertionError, etc.]
- 错误代码：[如果有错误码]

---

## 阶段 1：根因调查

### 1.1 错误信息分析

**堆栈跟踪分析**：
- [对堆栈跟踪的详细分析]
- [关键调用链路]

**初步判断**：
- [基于错误信息的初步判断]

### 1.2 问题重现

**重现步骤**：
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

**重现稳定性**：
- 每次都能重现：是 / 否
- 重现概率：[如 100% / 50% / 偶发]
- 环境依赖：[如特定操作系统、浏览器、数据状态]

### 1.3 最近更改检查

**相关提交**：
```bash
git log --oneline -10
```

**可疑更改**：
- 提交 [SHA]：[提交描述] - [为何可疑]
- 提交 [SHA]：[提交描述] - [为何可疑]

**依赖变化**：
- [新增/升级/删除的依赖]

**配置更改**：
- [配置文件的更改]

### 1.4 证据收集

**多组件系统诊断**：

> 仅在涉及多组件系统时填写

**组件边界日志**：
```bash
# 组件 1
[诊断日志输出]

# 组件 2
[诊断日志输出]

# 组件 3
[诊断日志输出]
```

**失败点定位**：
- 失败发生在：[具体组件/层级]
- 数据流向：[数据如何流经各组件]

### 1.5 数据流追踪

**错误值来源**：
- 错误值：[具体的错误值]
- 预期值：[应该是什么值]

**调用链追踪**（从症状向上追溯）：
```
第 5 层（症状）：[函数名] 在 [文件:行号] - 接收到错误值 [值]
    ↑ 被调用于
第 4 层：[函数名] 在 [文件:行号] - 传递参数 [值]
    ↑ 被调用于
第 3 层：[函数名] 在 [文件:行号] - 传递参数 [值]
    ↑ 被调用于
第 2 层：[函数名] 在 [文件:行号] - 传递参数 [值]
    ↑ 被调用于
第 1 层（根源）：[函数名] 在 [文件:行号] - 错误值产生于此
```

**根源定位**：
- 错误值产生位置：[文件:行号]
- 产生原因：[为什么产生错误值]

---

## 阶段 2：模式分析

### 2.1 有效示例查找

**类似场景的有效代码**：
- 文件：[文件路径]
- 位置：[行号范围]
- 说明：[这段代码如何正确处理类似情况]

```typescript
// 有效示例代码
[代码片段]
```

### 2.2 参考对比

**参考实现**：
- 来源：[如官方文档、参考库、最佳实践]
- 关键点：[参考实现的关键设计要点]

**当前实现**：
```typescript
// 当前的实现
[代码片段]
```

### 2.3 差异识别

**关键差异列表**：

| 差异点 | 有效代码 | 当前代码 | 影响分析 |
|--------|----------|----------|----------|
| [差异 1] | [有效代码的做法] | [当前代码的做法] | [可能的影响] |
| [差异 2] | [有效代码的做法] | [当前代码的做法] | [可能的影响] |
| [差异 3] | [有效代码的做法] | [当前代码的做法] | [可能的影响] |

**核心问题**：
- [基于差异分析总结的核心问题]

### 2.4 依赖分析

**所需组件**：
- [组件 1]：[状态/版本]
- [组件 2]：[状态/版本]

**配置要求**：
- [配置项 1]：[当前值] vs [预期值]
- [配置项 2]：[当前值] vs [预期值]

**环境假设**：
- [假设 1]：[是否满足]
- [假设 2]：[是否满足]

---

## 阶段 3：假设验证

### 假设 #1

**假设陈述**：
- 我认为 [X] 是根因，因为 [Y]

**测试方法**：
- [如何测试此假设的最小化方案]

**测试步骤**：
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

**测试结果**：
- 结果：✅ 验证通过 / ❌ 验证失败
- 观察到的现象：[测试过程中观察到的现象]
- 结论：[基于测试结果的结论]

### 假设 #2

> 仅在假设 #1 失败时填写

**假设陈述**：
- [新的假设]

**测试方法**：
- [测试方案]

**测试结果**：
- 结果：✅ 验证通过 / ❌ 验证失败
- 观察到的现象：[现象描述]
- 结论：[结论]

### 假设 #3

> 仅在假设 #2 失败时填写，如果到第 3 个假设仍失败，应考虑架构问题

---

## 阶段 4：修复实施

### 4.1 根因总结

**根本原因**：
- [一句话总结根本原因]

**详细说明**：
- [详细描述为什么会发生此问题]
- [问题的根源是什么]
- [为什么之前没有被发现]

### 4.2 失败测试用例

**测试文件**：[测试文件路径]

**测试代码**：
```typescript
test('重现 [问题描述]', async () => {
  // 测试代码
  // 预期：此测试应该失败，证明 bug 存在
});
```

**测试失败输出**：
```
[失败的测试输出，证明测试确实捕获了 bug]
```

### 4.3 修复方案

**修复策略**：
- [选择此修复策略的原因]

**修复代码**：

```typescript
// 修复前
[修复前的代码]

// 修复后
[修复后的代码]
```

**修复文件清单**：
- 修改：[文件 1] - [修改说明]
- 修改：[文件 2] - [修改说明]
- 新增：[文件 3] - [用途说明]

### 4.4 多层防御

> 应用 defense-in-depth 原则，在多个层次添加验证

**防御层次**：

| 层次 | 位置 | 验证内容 | 目的 |
|------|------|----------|------|
| 层 1 - 入口验证 | [文件:行号] | [验证逻辑] | 在 API 边界拒绝无效输入 |
| 层 2 - 业务逻辑 | [文件:行号] | [验证逻辑] | 确保数据对此操作有效 |
| 层 3 - 环境保护 | [文件:行号] | [验证逻辑] | 防止特定上下文的危险操作 |
| 层 4 - 调试日志 | [文件:行号] | [日志内容] | 捕获上下文以便将来调查 |

### 4.5 验证结果

**测试通过**：
```bash
# 运行修复后的测试
npm test [测试文件]

# 输出
[测试通过的输出]
```

**完整测试套件**：
```bash
# 运行所有测试
npm test

# 统计
总测试数：[X]
通过：[Y]
失败：[0]
```

**无回归验证**：
- ✅ 所有现有测试仍然通过
- ✅ 无新增警告或错误
- ✅ 性能无明显下降

### 4.6 失败记录

> 仅在修复失败时填写

**尝试次数**：[1/2/3]

**失败原因**：
- [为什么此次修复失败]

**下一步行动**：
- 如果 < 3 次：返回阶段 1，使用新信息重新分析
- 如果 = 3 次：质疑架构设计，与用户讨论

**架构反思**：

> 仅在 3 次修复失败后填写

**问题模式**：
- [ ] 每次修复揭示新的共享状态/耦合问题
- [ ] 修复需要大规模重构才能实施
- [ ] 每次修复在其他地方产生新症状

**根本问题**：
- [这个模式是否根本上合理？]
- [是否因惯性而坚持错误的设计？]
- [应该重构架构还是继续修复症状？]

**建议**：
- [架构级别的改进建议]

---

## Git 提交

**提交信息**：
```
fix: [简短描述]

[详细说明修复内容]

Root Cause: [根因简述]
Covers: [相关的 TC-* 编号，如 TC-FAULT-001, TC-BOUND-002]
```

**提交 SHA**：[提交后的 SHA]

**修改文件**：
```bash
git diff --stat [parent-sha] [commit-sha]
```

---

## 经验总结

### 关键发现

**技术发现**：
- [从此次调试中学到的技术要点]

**流程发现**：
- [哪些调试步骤特别有效]
- [哪些步骤可以改进]

### 预防措施

**代码层面**：
- [如何在代码中预防类似问题]
- [应该添加的验证/检查]

**流程层面**：
- [如何在开发流程中预防]
- [应该添加的测试类型]

**文档层面**：
- [需要更新的文档]
- [需要添加的注意事项]

### 相关问题

**可能受影响的区域**：
- [代码库中可能存在类似问题的区域]

**建议的后续检查**：
- [ ] 检查 [区域 1] 是否存在类似问题
- [ ] 检查 [区域 2] 是否存在类似问题
- [ ] 添加 [类型] 的测试覆盖

---

## 附录

### 调试时间线

| 时间 | 事件 | 备注 |
|------|------|------|
| [时:分] | 发现问题 | [简述] |
| [时:分] | 开始阶段 1 调查 | [简述] |
| [时:分] | 找到根因 | [简述] |
| [时:分] | 完成修复 | [简述] |

**总耗时**：[X] 小时 [Y] 分钟

### 参考资料

- [参考链接 1]
- [参考链接 2]

### 相关链接

- Issue：[GitHub Issue 链接]
- PR：[Pull Request 链接]
- 相关 Bug：[其他相关 bug 的链接]
