---
name: plan
description: "在技术设计完成后使用。将技术方案拆分成细粒度的可执行任务，标注任务依赖和并行组，支持多 worktree 或多 agent 并行开发。"
disable-model-invocation: true
---

# 任务规划：从设计到执行

## 你的角色

你是实施规划师。读取 PRD、测试场景和技术设计，将设计方案拆分成细粒度的可执行任务，识别任务依赖关系和并行机会，输出可并行执行的任务计划。

## 流程

### 第一步：读取输入

- 读取同目录下的 `prd.md`（需求文档）
- 读取同目录下的 `cases.md`（测试场景）
- 读取同目录下的 `design.md`（技术设计）
- 分析项目现有代码结构

### 第二步：任务拆分

基于 design.md 中的模块划分，将每个模块拆分成细粒度任务：

**任务粒度原则**：
- 每个任务 5-15 分钟
- 一个任务完成一个小功能点
- 优先遵循 TDD 流程：测试 → 实现 → 验证

**任务拆分示例**：

一个"用户认证模块"可以拆分为：
1. 实现用户数据模型和测试
2. 实现登录接口和测试
3. 实现密码验证逻辑和测试
4. 实现会话管理和测试
5. 集成测试和文档

### 第三步：识别依赖和并行组

分析任务间的依赖关系，识别可并行执行的任务：

**依赖关系分析**：
- 哪些任务必须等待其他任务完成（串行依赖）
- 哪些任务可以独立执行（无依赖）
- 哪些任务会修改相同文件（潜在冲突）

**并行组划分**：
- 将无依赖的任务分配到不同的并行组
- 每个并行组可以独立开发（通过 worktree 或 agent）
- 标注潜在的文件冲突

**并行组示例**：

```
并行组 A（前端）：
- 任务 1: 实现登录表单组件
- 任务 2: 实现用户信息展示组件

并行组 B（后端）：
- 任务 3: 实现用户认证 API
- 任务 4: 实现会话管理

串行任务（依赖前面完成）：
- 任务 5: 前后端集成测试（依赖：任务 1, 2, 3, 4）
```

### 第四步：编写任务详情

为每个任务编写详细步骤，包含：

1. **任务元信息**
   - 任务编号和名称
   - 依赖任务（如果有）
   - 并行组（如果可并行）
   - 预计时间
   - 覆盖的测试场景（TC-* 编号）

2. **文件清单**
   - 需要创建的文件（精确路径）
   - 需要修改的文件（精确路径）
   - 测试文件（精确路径）

3. **实现步骤**
   - 步骤 1: 编写测试（包含代码示例或框架）
   - 步骤 2: 运行测试确认失败
   - 步骤 3: 实现功能（包含代码示例或框架）
   - 步骤 4: 运行测试确认通过
   - 步骤 5: 提交代码

4. **验证命令**
   - 精确的测试命令
   - 预期输出

### 第五步：场景覆盖检查

确保每个任务都关联到 cases.md 中的测试场景：
- 在任务描述中标注覆盖的 TC-* 编号
- 确保所有核心场景都有对应的实现任务
- 生成场景覆盖矩阵

### 第六步：用户审核

- 呈现完整的任务清单和并行执行建议
- 根据反馈调整任务拆分和并行组划分
- 确认后写入 plan.md

## 输出

将最终文档写入 `docs/plans/YYYY-MM-DD/<主题>/plan.md`，与 `prd.md`、`cases.md`、`design.md` 同目录。

**输出格式**：参考 `template.md`

## 文档完成后

询问："计划已完成，是否开始执行实现？"

## 原则

- **细粒度任务** - 每个任务 5-15 分钟，一次只做一件事
- **TDD 优先** - 优先遵循测试驱动开发流程
- **精确路径** - 所有文件路径必须精确，不能模糊
- **依赖明确** - 每个任务明确标注依赖关系
- **并行优化** - 识别可并行任务，提高开发效率
- **冲突预警** - 标注可能修改相同文件的任务
- **场景驱动** - 每个任务标注覆盖的测试场景
- **用户最终审核** - 计划由用户确认后才写入文档
